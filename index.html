<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>League of Lenses</title>
    <link rel="icon" href="icon.png" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;900&family=Rajdhani:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --hex-gold: #c8aa6e;
        --hex-gold-dim: #785a28;
        --hex-blue: #0ac8b9;
        --hex-dark: #010a13;
        --hex-panel: rgba(10, 20, 40, 0.95);
      }

      /* --- Atmospheric Background --- */
      body {
        background-color: var(--hex-dark);
        background-image: radial-gradient(
            circle at 50% 0%,
            #1e2f47 0%,
            #010a13 80%
          ),
          url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0l25.98 15v30L30 60 4.02 45V15z' fill-opacity='0.03' fill='%23C8AA6E' fill-rule='evenodd'/%3E%3C/svg%3E");
        color: #f0f0f0;
        font-family: "Rajdhani", sans-serif;
        overflow-x: hidden;
      }

      h1,
      h2,
      h3,
      h4 {
        font-family: "Cinzel", serif;
        letter-spacing: 0.05em;
      }

      /* --- Hextech Borders & Glows --- */
      .hex-panel {
        background: var(--hex-panel);
        border: 1px solid var(--hex-gold-dim);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.8),
          inset 0 0 0 1px rgba(200, 170, 110, 0.1);
        backdrop-filter: blur(8px);
        position: relative;
      }

      .hex-panel::after {
        content: "";
        position: absolute;
        top: -1px;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 1px;
        background: var(--hex-gold);
        box-shadow: 0 0 10px var(--hex-gold);
      }

      /* --- Inputs --- */
      .game-input {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid #333;
        color: var(--hex-blue);
        transition: all 0.3s ease;
        font-family: "Rajdhani", sans-serif;
        font-weight: 600;
        letter-spacing: 1px;
      }
      .game-input:focus {
        border-color: var(--hex-blue);
        box-shadow: 0 0 10px rgba(10, 200, 185, 0.3);
        outline: none;
      }

      /* --- Drop Zone --- */
      .drop-zone {
        background: radial-gradient(
          circle,
          rgba(10, 200, 185, 0.05) 0%,
          rgba(0, 0, 0, 0) 70%
        );
        border: 2px dashed var(--hex-gold-dim);
        transition: all 0.3s ease;
      }
      .drop-zone:hover {
        border-color: var(--hex-blue);
        background: radial-gradient(
          circle,
          rgba(10, 200, 185, 0.1) 0%,
          rgba(0, 0, 0, 0) 70%
        );
      }

      /* --- Staggered Animation --- */
      .animate-enter {
        opacity: 0;
        transform: translateY(20px);
        animation: slideUpFade 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      }
      .delay-1 {
        animation-delay: 0.1s;
      }
      .delay-2 {
        animation-delay: 0.2s;
      }
      .delay-3 {
        animation-delay: 0.3s;
      }
      .delay-4 {
        animation-delay: 0.4s;
      }

      @keyframes slideUpFade {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* --- Loader --- */
      .loader-rune {
        border: 3px solid rgba(200, 170, 110, 0.2);
        border-top: 3px solid var(--hex-gold);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      .loader-rune-sm {
        border: 2px solid rgba(200, 170, 110, 0.2);
        border-top: 2px solid var(--hex-gold);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* --- Modal Styles --- */
      #modal-overlay {
        background: rgba(1, 10, 19, 0.9);
      }

      /* History Scrollbar */
      .history-scroll::-webkit-scrollbar {
        width: 6px;
      }
      .history-scroll::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
      }
      .history-scroll::-webkit-scrollbar-thumb {
        background: var(--hex-gold-dim);
        border-radius: 3px;
      }
    </style>
  </head>

  <body
    class="min-h-screen flex flex-col items-center justify-start pt-12 pb-20 selection:bg-cyan-900 selection:text-cyan-100 relative"
  >
    <div
      class="fixed top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#C8AA6E] to-transparent opacity-50 z-40"
    ></div>

    <div class="topcontainer text-center mb-10 animate-enter">
      <h1
        class="text-5xl md:text-7xl font-bold bg-clip-text text-transparent bg-gradient-to-b from-[#F0E6D2] to-[#C8AA6E] drop-shadow-[0_2px_10px_rgba(200,170,110,0.3)]"
      >
        LEAGUE OF LENSES
      </h1>
      <p
        class="text-[#0AC8B9] tracking-[0.3em] text-sm mt-2 uppercase font-bold opacity-80"
      >
        Summoner's Rift to Shorts Converter
      </p>
    </div>

    <div
      class="w-full max-w-6xl px-4 grid grid-cols-1 lg:grid-cols-2 gap-12 items-start"
    >
      <div class="flex flex-col items-center w-full animate-enter delay-1">
        <form
          id="form"
          class="w-full max-w-lg hex-panel rounded-xl p-1 bg-opacity-50"
        >
          <div class="p-8 flex flex-col space-y-6">
            <div class="relative group">
              <div class="hero2 w-full h-[280px] relative">
                <label
                  for="input-file"
                  id="drop-area"
                  class="drop-zone w-full h-full flex justify-center items-center flex-col rounded-lg cursor-pointer overflow-hidden relative"
                >
                  <input
                    type="file"
                    name="input-file"
                    id="input-file"
                    accept=".mp4, .mov"
                    required
                    hidden
                  />

                  <div
                    id="upload-prompt"
                    class="text-center transition-opacity duration-300"
                  >
                    <div
                      class="mb-4 mx-auto w-16 h-16 border-2 border-[#C8AA6E] rounded-full flex items-center justify-center text-[#C8AA6E] group-hover:bg-[#C8AA6E] group-hover:text-black transition-colors"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-8 h-8"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"
                        />
                      </svg>
                    </div>
                    <p class="text-xl font-bold text-[#f0f0f0]">
                      DROP REPLAY HERE
                    </p>
                    <p class="text-sm text-[#0AC8B9] mt-1 opacity-70">
                      .MP4 or .MOV
                    </p>
                  </div>

                  <div
                    id="loading-box"
                    class="hidden flex-col items-center justify-center w-full h-full absolute top-0 left-0 bg-black/80 z-20"
                  >
                    <div class="loader-rune mb-3"></div>
                    <span
                      class="text-[#C8AA6E] tracking-widest text-sm animate-pulse"
                      id="loading-text"
                      >ANALYZING RIFT DATA...</span
                    >
                  </div>

                  <div
                    id="video-wrapper"
                    class="hidden w-full h-full relative group/video"
                  >
                    <button
                      type="button"
                      id="cancel-btn"
                      class="absolute top-2 right-2 z-20 bg-black/60 border border-gray-600 text-gray-400 hover:border-red-500 hover:bg-red-900/80 hover:text-red-400 p-1.5 rounded-md opacity-0 group-hover/video:opacity-100 transition-all duration-200"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-5 h-5"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M6 18L18 6M6 6l12 12"
                        />
                      </svg>
                    </button>

                    <video
                      id="vid"
                      class="w-full h-full object-cover rounded-lg"
                      controls
                      playsinline
                    ></video>
                  </div>
                </label>
              </div>
            </div>

            <div
              id="time"
              class="grid grid-cols-2 gap-6 pt-4 border-t border-white/10"
            >
              <div class="space-y-2">
                <h4
                  class="text-[#C8AA6E] text-xs uppercase tracking-widest text-center"
                >
                  In-Game Start
                </h4>
                <div class="flex items-center space-x-2">
                  <input
                    type="number"
                    placeholder="00"
                    id="start-min"
                    class="game-input w-full p-2 text-center rounded text-xl"
                  />
                  <span class="text-gray-500 font-bold">:</span>
                  <input
                    type="number"
                    placeholder="00"
                    id="start-sec"
                    class="game-input w-full p-2 text-center rounded text-xl"
                  />
                </div>
              </div>

              <div class="space-y-2">
                <h4
                  class="text-[#C8AA6E] text-xs uppercase tracking-widest text-center"
                >
                  In-Game End
                </h4>
                <div class="flex items-center space-x-2">
                  <input
                    type="number"
                    placeholder="00"
                    id="end-min"
                    class="game-input w-full p-2 text-center rounded text-xl"
                  />
                  <span class="text-gray-500 font-bold">:</span>
                  <input
                    type="number"
                    placeholder="00"
                    id="end-sec"
                    class="game-input w-full p-2 text-center rounded text-xl"
                  />
                </div>
              </div>
            </div>

            <div class="flex items-center justify-center space-x-3 pt-2">
              <input
                type="checkbox"
                id="audio"
                name="audio"
                checked
                class="w-5 h-5 accent-[#0AC8B9] cursor-pointer bg-gray-800 border-gray-600 rounded focus:ring-[#0AC8B9]"
              />
              <label
                for="audio"
                class="text-gray-300 text-sm tracking-wide cursor-pointer select-none"
                >INCLUDE AUDIO TRACK</label
              >
            </div>

            <div id="submit" class="pt-4">
              <button
                type="submit"
                class="w-full relative overflow-hidden group bg-gradient-to-r from-[#091428] to-[#1e2f47] border border-[#C8AA6E] text-[#C8AA6E] p-4 rounded hover:text-white transition-all duration-300"
              >
                <div
                  class="absolute inset-0 w-0 bg-[#C8AA6E] transition-all duration-[250ms] ease-out group-hover:w-full opacity-100"
                ></div>
                <span
                  class="relative font-cinzel font-bold text-xl tracking-[0.2em] group-hover:text-black z-10 uppercase"
                >
                  Isolate Highlights
                </span>
              </button>
            </div>
          </div>
        </form>
      </div>

      <div
        class="text-left text-gray-300 space-y-8 animate-enter delay-2 lg:pt-0"
      >
        <div
          id="history-container"
          class="hex-panel rounded-xl p-6 bg-opacity-30 mb-8 hidden"
        >
          <div
            class="flex items-center justify-between border-b border-gray-700 pb-3 mb-4"
          >
            <h3 class="text-xl text-[#C8AA6E]">Match History</h3>
            <div class="flex items-center space-x-3">
              <span class="text-xs text-gray-500 uppercase tracking-widest"
                >Local Storage</span
              >
              <button
                id="clear-history-btn"
                class="text-[10px] text-red-900 hover:text-red-500 border border-red-900/30 hover:border-red-500 px-2 py-0.5 rounded transition-colors uppercase tracking-wider font-bold"
              >
                Clear
              </button>
            </div>
          </div>

          <div
            id="history-list"
            class="space-y-4 max-h-[300px] overflow-y-auto history-scroll pr-2"
          >
            <div class="text-center text-gray-600 text-sm italic py-4">
              No recent highlights.
            </div>
          </div>
        </div>

        <div class="prose prose-invert max-w-none">
          <p
            class="text-xl leading-relaxed font-light text-gray-400 border-l-2 border-[#0AC8B9] pl-6 italic"
          >
            "Every pentakill deserves an audience."
          </p>

          <div class="mt-8 space-y-6">
            <h3 class="text-2xl text-[#C8AA6E] border-b border-gray-800 pb-2">
              Automatic Zoom Tech
            </h3>
            <p>
              League of Lenses isn't just a cropper. It analyzes your
              <strong class="text-[#0AC8B9]">Champion focus</strong> and
              <strong class="text-[#0AC8B9]">teamfight density</strong> to
              dynamically pan (zoom WIP), ensuring your vertical YouTube Shorts
              capture every skillshot without losing the HUD context.
            </p>

            <h3
              class="text-2xl text-[#C8AA6E] border-b border-gray-800 pb-2 mt-8"
            >
              How to Operate
            </h3>
            <ul class="space-y-4 font-light">
              <li class="flex items-start">
                <span class="text-[#0AC8B9] font-bold mr-3">01.</span>
                <span>Drag your replay file into the hex-portal.</span>
              </li>
              <li class="flex items-start">
                <span class="text-[#0AC8B9] font-bold mr-3">02.</span>
                <span>Confirm start/end times (Auto-detected).</span>
              </li>
              <li class="flex items-start">
                <span class="text-[#0AC8B9] font-bold mr-3">03.</span>
                <span
                  >Click <strong>Isolate Highlights</strong>. The main view will
                  clear, and the job will appear in your
                  <strong>Match History</strong>.</span
                >
              </li>
              <li class="flex items-start">
                <span class="text-[#0AC8B9] font-bold mr-3">04.</span>
                <span
                  >Download your clip from the History panel.
                  <span class="text-red-400"
                    >Links expire after 1 hour.</span
                  ></span
                >
              </li>
            </ul>
          </div>
        </div>

        <div class="text-xs text-gray-500 mt-12 border-t border-gray-800 pt-6">
          <p>
            By using League of Lenses, you agree to our
            <a
              href="tos.html"
              class="text-[#C8AA6E] hover:text-[#0AC8B9] underline decoration-dotted underline-offset-4 transition-colors"
            >
              Terms of Service </a
            >.
            <span class="block mt-1 opacity-70"
              >Video files are automatically purged after 3 days.</span
            >
          </p>
        </div>
      </div>
    </div>

    <div
      id="modal-overlay"
      class="fixed inset-0 z-50 hidden backdrop-blur-md flex items-center justify-center p-4 md:p-10"
    >
      <div class="relative w-full max-w-6xl hex-panel shadow-2xl flex flex-col">
        <div
          class="flex justify-between items-center p-4 border-b border-[#785A28]/50 bg-black/40"
        >
          <h3 class="text-[#C8AA6E] tracking-widest uppercase">
            Video Inspection
          </h3>
          <button
            id="close-modal"
            class="text-gray-400 hover:text-white hover:scale-110 transition-transform"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              class="w-8 h-8"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="relative w-full bg-black aspect-video">
          <video id="modal-video" class="w-full h-full" controls></video>
        </div>
      </div>
    </div>

    <footer
      id="footer"
      class="w-full text-center py-8 mt-auto text-gray-600 animate-enter delay-3"
    >
      <small class="tracking-widest uppercase text-[10px]"
        >Ming Lin © 2024 • Forged in Gemini :)</small
      >
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      // --- DOM ELEMENTS ---
      const form = document.getElementById("form");
      const fileInput = document.getElementById("input-file");

      // UI Containers
      const uploadPrompt = document.getElementById("upload-prompt");
      const loadingBox = document.getElementById("loading-box");
      const loadingText = document.getElementById("loading-text");
      const videoWrapper = document.getElementById("video-wrapper");
      const previewVideo = document.getElementById("vid");
      const submitBtnContainer = document.getElementById("submit");

      // History Elements
      const historyContainer = document.getElementById("history-container");
      const historyList = document.getElementById("history-list");
      const clearHistoryBtn = document.getElementById("clear-history-btn");

      // Inputs
      const startMin = document.getElementById("start-min");
      const startSec = document.getElementById("start-sec");
      const endMin = document.getElementById("end-min");
      const endSec = document.getElementById("end-sec");
      const audioCheck = document.getElementById("audio");

      // Modal Elements
      const modalOverlay = document.getElementById("modal-overlay");
      const modalVideo = document.getElementById("modal-video");
      const closeModalBtn = document.getElementById("close-modal");

      // --- HELPER FUNCTIONS ---

      function makeid(length) {
        let result = "";
        const characters =
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        const charactersLength = characters.length;
        let counter = 0;
        while (counter < length) {
          result += characters.charAt(
            Math.floor(Math.random() * charactersLength)
          );
          counter += 1;
        }
        return result;
      }

      const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

      // --- HISTORY MANAGEMENT (LOCAL STORAGE) ---

      const getHistory = () => {
        const stored = localStorage.getItem("lol_history");
        return stored ? JSON.parse(stored) : [];
      };

      const saveHistory = (history) => {
        localStorage.setItem("lol_history", JSON.stringify(history));
        renderHistory();
      };

      const addHistoryItem = (item) => {
        const history = getHistory();
        history.unshift(item);
        if (history.length > 10) history.pop();
        saveHistory(history);
      };

      const updateHistoryItem = (id, updates) => {
        const history = getHistory();
        const index = history.findIndex((h) => h.id === id);
        if (index !== -1) {
          history[index] = { ...history[index], ...updates };
          saveHistory(history);
        }
      };

      clearHistoryBtn.addEventListener("click", () => {
        if (confirm("Are you sure you want to clear your local history?")) {
          localStorage.removeItem("lol_history");
          renderHistory();
        }
      });

      // --- HISTORY RENDERING ---

      const renderHistory = () => {
        const history = getHistory();
        if (history.length > 0) {
          historyContainer.classList.remove("hidden");
          historyList.innerHTML = "";
        } else {
          historyContainer.classList.add("hidden");
          return;
        }

        const now = Date.now();

        history.forEach((item) => {
          const card = document.createElement("div");
          card.className =
            "bg-black/40 border border-[#785A28]/30 rounded p-3 flex flex-col space-y-2";
          const date = new Date(item.timestamp).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });

          let statusHtml = "";

          if (item.status === "processing") {
            statusHtml = `
          <div class="flex items-center space-x-2 text-[#C8AA6E] animate-pulse">
             <div class="loader-rune-sm"></div>
             <span class="text-sm font-bold tracking-wider">PROCESSING</span>
          </div>`;
          } else if (item.status === "completed") {
            if (now > item.expiresAt) {
              statusHtml = `
            <div class="flex items-center justify-between w-full">
               <span class="text-red-900 font-bold bg-red-900/20 px-2 py-1 rounded text-xs border border-red-900">LINK EXPIRED</span>
               <span class="text-xs text-gray-600">Re-upload required</span>
            </div>`;
            } else {
              const minutesLeft = Math.ceil((item.expiresAt - now) / 60000);
              statusHtml = `
            <div class="flex flex-col space-y-2 w-full">
               <a href="${item.link}" target="_blank" class="block w-full text-center py-2 rounded border border-[#0AC8B9] text-[#0AC8B9] text-sm font-bold hover:bg-[#0AC8B9] hover:text-black transition-all uppercase tracking-widest shadow-[0_0_10px_rgba(10,200,185,0.2)]">
                 Download Highlight
               </a>
               <span class="text-[10px] text-center text-gray-500">Expires in <span class="text-[#C8AA6E]">${minutesLeft} mins</span></span>
            </div>`;
            }
          } else {
            statusHtml = `<span class="text-red-500 font-bold text-xs">PROCESSING FAILED</span>`;
          }

          card.innerHTML = `
        <div class="flex justify-between items-start">
            <div>
                <div class="text-gray-300 font-bold text-sm truncate max-w-[150px]">${
                  item.originalName || "Replay Clip"
                }</div>
                <div class="text-[10px] text-gray-600 uppercase tracking-widest">${date}</div>
            </div>
        </div>
        <div class="pt-1 border-t border-white/5 mt-1">
            ${statusHtml}
        </div>`;
          historyList.appendChild(card);
        });
      };

      setInterval(renderHistory, 60000);

      const pollForProgress = async (queueURL, historyId) => {
        const postUrl =
          "https://n4g5fjhkqdah2chkv7xzpadfby0gexzo.lambda-url.us-east-1.on.aws/";
        let stop = false;
        let attempts = 0;

        console.log(`Starting polling for ${historyId} using ${queueURL}`);

        while (!stop) {
          // Timeout protection (approx 3 mins)
          if (attempts > 60) {
            updateHistoryItem(historyId, { status: "failed" });
            throw new Error("Processing timed out.");
          }

          try {
            const pollRes = await axios.post(postUrl, { queueURL: queueURL });
            const responseBody = pollRes.data;

            console.log("Poll Response:", responseBody);

            // If we get data back, the lambda has finished (either success or error)
            if (responseBody) {
              // Ensure it's a string for comparison
              const responseString = String(responseBody);

              // --- SCENARIO 1: ERROR ---
              // Check if the string contains "error" (case-insensitive)
              if (responseString.toLowerCase().includes("error")) {
                console.error("Job Failed:", responseString);
                updateHistoryItem(historyId, { status: "failed" });
                stop = true;
              }

              // --- SCENARIO 2: SUCCESS ---
              // Otherwise, we assume it is the download link
              else {
                updateHistoryItem(historyId, {
                  status: "completed",
                  link: responseString,
                  expiresAt: Date.now() + 3600000,
                });
                stop = true;
              }
            }
            // If responseBody is null/empty, the job is likely still running
            else {
              console.log("Job still processing...");
              await sleep(3000);
              attempts++;
            }
          } catch (error) {
            // Network errors or 500s from the polling endpoint itself -> Retry
            console.warn("Polling retry...", error);
            await sleep(3000);
            attempts++;
          }
        }
      };
      // --- EVENT LISTENERS ---

      fileInput.addEventListener("change", () => {
        if (fileInput.files && fileInput.files[0]) {
          const file = fileInput.files[0];
          const fileURL = URL.createObjectURL(file);
          uploadPrompt.classList.add("hidden");
          loadingBox.classList.remove("hidden");
          loadingBox.style.display = "flex";
          loadingText.innerText = "ANALYZING RIFT DATA...";
          setTimeout(() => {
            loadingBox.style.display = "none";
            videoWrapper.classList.remove("hidden");
            previewVideo.src = fileURL;
            modalVideo.src = fileURL;
            previewVideo.load();
          }, 800);
        }
      });

      previewVideo.addEventListener("loadedmetadata", function () {
        const duration = previewVideo.duration;
        if (isFinite(duration)) {
          const minutes = Math.floor(duration / 60);
          const seconds = Math.floor(duration % 60);
          endMin.value = minutes;
          endSec.value = seconds;
        }
      });

      const cancelBtn = document.getElementById("cancel-btn");
      const resetFormUI = () => {
        fileInput.value = "";
        previewVideo.pause();
        previewVideo.src = "";
        videoWrapper.classList.add("hidden");
        uploadPrompt.classList.remove("hidden");
        loadingBox.style.display = "none";
        submitBtnContainer.classList.remove("hidden");
        startMin.value = "";
        startSec.value = "";
        endMin.value = "";
        endSec.value = "";
      };
      cancelBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        resetFormUI();
      });

      const closeModal = () => {
        previewVideo.currentTime = modalVideo.currentTime;
        modalVideo.pause();
        modalOverlay.classList.add("hidden");
      };
      closeModalBtn.addEventListener("click", closeModal);
      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) closeModal();
      });

      // --- CORE UPLOAD LOGIC ---

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const file = fileInput.files[0];
        if (!file) {
          alert("Please select a video file first.");
          return;
        }

        const duration = Math.round(previewVideo.duration || 0);
        let endingInput = Number(endMin.value) * 60 + Number(endSec.value);
        let endingSec =
          (endMin.value !== "" || endSec.value !== "") &&
          endingInput <= duration
            ? endingInput
            : duration;
        const startingInput =
          Number(startMin.value) * 60 + Number(startSec.value);
        let startingSec = startingInput < endingSec ? startingInput : 0;
        const audioBool = audioCheck.checked ? "A" : "M";

        const fileID = makeid(5);
        const newFileName = `${fileID}-${startingSec}-${endingSec}-${audioBool}`;

        const historyId = Date.now().toString();

        // 1. Initial History Entry (No queueURL yet)
        addHistoryItem({
          id: historyId,
          originalName: file.name,
          timestamp: Date.now(),
          status: "processing",
          link: null,
          queueURL: null, // Placeholder
          expiresAt: null,
        });

        resetFormUI();
        historyContainer.classList.remove("hidden");

        try {
          // 2. Get Upload Key
          const apiUrl =
            "https://4f1wirqn9k.execute-api.us-east-1.amazonaws.com/Prod/upload";
          const uploadRes = await axios.post(apiUrl, {
            filename: newFileName + ".mp4",
            withCredentials: false,
          });

          const { uploadUrl, fileKey, queueURL } = uploadRes.data;

          // 3. IMPORTANT: Update History with the queueURL immediately
          // This allows the job to be resumed if the user reloads now
          updateHistoryItem(historyId, {
            queueURL: queueURL,
          });

          // 4. Upload to S3
          await axios.put(uploadUrl, file, {
            headers: {
              "Content-Type": "video/mp4",
            },
          });

          // 5. Start Polling
          pollForProgress(queueURL, historyId);
        } catch (err) {
          console.error("Error in workflow:", err);
          updateHistoryItem(historyId, {
            status: "failed",
          });
          alert("An error occurred. Check history.");
        }
      });

      // --- LOGIC: ON LOAD (RESUME JOBS) ---

      window.addEventListener("DOMContentLoaded", () => {
        renderHistory();

        // Check for interrupted jobs
        const history = getHistory();
        history.forEach((item) => {
          // If status is processing AND we have the queueURL saved
          if (item.status === "processing" && item.queueURL) {
            console.log(`Resuming interrupted job: ${item.originalName}`);
            pollForProgress(item.queueURL, item.id);
          }
        });
      });
    </script>
  </body>
</html>
